import{a as C,b as E,f as O}from"../chunk-AVGKNGVI.js";import R from"fs";import rt from"fs/promises";import b from"path";import xt from"lodash";function It(r="plugin"){switch(r){case"root":case"yunzai":return`${C}/`;case"res":return`${E}/resources/`;default:return`${E}/`}}function T(r,t="plugin"){return b.isAbsolute(r)?r:b.resolve(It(t),r)}var J=class{static JSONCache=new Map;static createDir(t="",e="plugin",i=!1){let s=T(t,e),n=i?b.dirname(s):s;R.existsSync(n)||R.mkdirSync(n,{recursive:!0})}static getJSON(t,e="plugin",i=!0){let s=T(t,e);if(i&&this.JSONCache.has(s))return this.JSONCache.get(s);if(!R.existsSync(s))return{};try{let n=JSON.parse(R.readFileSync(s,"utf8"));return i&&this.JSONCache.set(s,n),n}catch(n){return logger.error("\u8BFB\u53D6 JSON \u6587\u4EF6\u9519\u8BEF",n),{}}}static async readJSON(t,e="plugin"){let i=T(t,e);try{let s=await rt.readFile(i,"utf8");return JSON.parse(s)}catch{return{}}}static async writeJSON(t,e,i="plugin",s=2){let n=T(t,i);try{return this.createDir(n,i,!0),await rt.writeFile(n,JSON.stringify(e,null,s)),this.JSONCache.set(n,e),!0}catch(a){return logger.error(a),!1}}static async getRedisJSON(t){try{let e=await redis.get(t);return e?JSON.parse(e):{}}catch(e){return logger.error(e),{}}}static async setRedisJSON(t,e,i=3600*24*90){await redis.set(t,JSON.stringify(e),{EX:i})}static async importModule(t,e="plugin"){let i=T(t.endsWith(".js")?t:`${t}.js`,e);if(!R.existsSync(i))return{};try{return await import(`file://${i}?t=${Date.now()}`)??{}}catch(s){return logger.error(s),{}}}static async importDefault(t,e){return(await this.importModule(t,e)).default??{}}static readDirRecursive(t,e,i){let s=T(t),n=R.readdirSync(s,{withFileTypes:!0}),a=[];for(let o of n){let h=b.join(s,o.name);if(o.isDirectory()){if(o.name===i)continue;let l=this.readDirRecursive(h,e,i);a.push(...l.map(c=>b.join(o.name,c)))}else b.extname(o.name)===`.${e}`&&a.push(o.name)}return a}static async asyncPool(t,e,i){let s=[],n=[];for(let a of e){let o=Promise.resolve().then(()=>i(a,e));if(s.push(o),t<=e.length){let h=o.finally(()=>n.splice(n.indexOf(h),1));n.push(h),n.length>=t&&await Promise.race(n)}}return Promise.all(s)}static sleep(t){return new Promise(e=>setTimeout(e,t))}static def(...t){return t.find(e=>!xt.isUndefined(e))}static eachStr(t,e){let i;typeof t=="string"?i=t.replace(/\s*(;|；|、|，)\s*/g,",").split(","):typeof t=="number"?i=[t.toString()]:i=t,i.forEach((s,n)=>e(s.trim?.()??s,n))}static regRet(t,e,i){return t.exec(e)?.[i]??!1}},D=J;import Te from"fs";import A from"path";import{stat as ne}from"fs";import{stat as oe,readdir as ae}from"fs/promises";import{EventEmitter as he}from"events";import*as d from"path";import{stat as Nt,lstat as nt,readdir as Ft,realpath as At}from"fs/promises";import{Readable as Ct}from"stream";import{resolve as ot,relative as Ot,join as Wt,sep as Lt}from"path";var g={FILE_TYPE:"files",DIR_TYPE:"directories",FILE_DIR_TYPE:"files_directories",EVERYTHING_TYPE:"all"},$={root:".",fileFilter:r=>!0,directoryFilter:r=>!0,type:g.FILE_TYPE,lstat:!1,depth:2147483648,alwaysStat:!1,highWaterMark:4096};Object.freeze($);var lt="READDIRP_RECURSIVE_ERROR",kt=new Set(["ENOENT","EPERM","EACCES","ELOOP",lt]),at=[g.DIR_TYPE,g.EVERYTHING_TYPE,g.FILE_DIR_TYPE,g.FILE_TYPE],jt=new Set([g.DIR_TYPE,g.EVERYTHING_TYPE,g.FILE_DIR_TYPE]),zt=new Set([g.EVERYTHING_TYPE,g.FILE_DIR_TYPE,g.FILE_TYPE]),Mt=r=>kt.has(r.code),Ht=process.platform==="win32",ht=r=>!0,ct=r=>{if(r===void 0)return ht;if(typeof r=="function")return r;if(typeof r=="string"){let t=r.trim();return e=>e.basename===t}if(Array.isArray(r)){let t=r.map(e=>e.trim());return e=>t.some(i=>e.basename===i)}return ht},G=class extends Ct{constructor(t={}){super({objectMode:!0,autoDestroy:!0,highWaterMark:t.highWaterMark});let e={...$,...t},{root:i,type:s}=e;this._fileFilter=ct(e.fileFilter),this._directoryFilter=ct(e.directoryFilter);let n=e.lstat?nt:Nt;Ht?this._stat=a=>n(a,{bigint:!0}):this._stat=n,this._maxDepth=e.depth??$.depth,this._wantsDir=s?jt.has(s):!1,this._wantsFile=s?zt.has(s):!1,this._wantsEverything=s===g.EVERYTHING_TYPE,this._root=ot(i),this._isDirent=!e.alwaysStat,this._statsProp=this._isDirent?"dirent":"stats",this._rdOptions={encoding:"utf8",withFileTypes:this._isDirent},this.parents=[this._exploreDir(i,1)],this.reading=!1,this.parent=void 0}async _read(t){if(!this.reading){this.reading=!0;try{for(;!this.destroyed&&t>0;){let e=this.parent,i=e&&e.files;if(i&&i.length>0){let{path:s,depth:n}=e,a=i.splice(0,t).map(h=>this._formatEntry(h,s)),o=await Promise.all(a);for(let h of o){if(!h)continue;if(this.destroyed)return;let l=await this._getEntryType(h);l==="directory"&&this._directoryFilter(h)?(n<=this._maxDepth&&this.parents.push(this._exploreDir(h.fullPath,n+1)),this._wantsDir&&(this.push(h),t--)):(l==="file"||this._includeAsFile(h))&&this._fileFilter(h)&&this._wantsFile&&(this.push(h),t--)}}else{let s=this.parents.pop();if(!s){this.push(null);break}if(this.parent=await s,this.destroyed)return}}}catch(e){this.destroy(e)}finally{this.reading=!1}}}async _exploreDir(t,e){let i;try{i=await Ft(t,this._rdOptions)}catch(s){this._onError(s)}return{files:i,depth:e,path:t}}async _formatEntry(t,e){let i,s=this._isDirent?t.name:t;try{let n=ot(Wt(e,s));i={path:Ot(this._root,n),fullPath:n,basename:s},i[this._statsProp]=this._isDirent?t:await this._stat(n)}catch(n){this._onError(n);return}return i}_onError(t){Mt(t)&&!this.destroyed?this.emit("warn",t):this.destroy(t)}async _getEntryType(t){if(!t&&this._statsProp in t)return"";let e=t[this._statsProp];if(e.isFile())return"file";if(e.isDirectory())return"directory";if(e&&e.isSymbolicLink()){let i=t.fullPath;try{let s=await At(i),n=await nt(s);if(n.isFile())return"file";if(n.isDirectory()){let a=s.length;if(i.startsWith(s)&&i.substr(a,1)===Lt){let o=new Error(`Circular symlink detected: "${i}" points to "${s}"`);return o.code=lt,this._onError(o)}return"directory"}}catch(s){return this._onError(s),""}}}_includeAsFile(t){let e=t&&t[this._statsProp];return e&&this._wantsEverything&&!e.isDirectory()}};function ft(r,t={}){let e=t.entryType||t.type;if(e==="both"&&(e=g.FILE_DIR_TYPE),e&&(t.type=e),r){if(typeof r!="string")throw new TypeError("readdirp: root argument must be a string. Usage: readdirp(root, options)");if(e&&!at.includes(e))throw new Error(`readdirp: Invalid type passed. Use one of ${at.join(", ")}`)}else throw new Error("readdirp: root argument is required. Usage: readdirp(root, options)");return t.root=r,new G(t)}import{watchFile as Yt,unwatchFile as dt,watch as Ut}from"fs";import{open as Jt,stat as mt,lstat as $t,realpath as K}from"fs/promises";import*as m from"path";import{type as Gt}from"os";var Kt="data",q="end",pt="close",z=()=>{};var M=process.platform,Q=M==="win32",Vt=M==="darwin",Bt=M==="linux",qt=M==="freebsd",_t=Gt()==="OS400",p={ALL:"all",READY:"ready",ADD:"add",CHANGE:"change",ADD_DIR:"addDir",UNLINK:"unlink",UNLINK_DIR:"unlinkDir",RAW:"raw",ERROR:"error"},y=p,Qt="watch",Xt={lstat:$t,stat:mt},P="listeners",W="errHandlers",v="rawEmitters",Zt=[P,W,v],te=new Set(["3dm","3ds","3g2","3gp","7z","a","aac","adp","afdesign","afphoto","afpub","ai","aif","aiff","alz","ape","apk","appimage","ar","arj","asf","au","avi","bak","baml","bh","bin","bk","bmp","btif","bz2","bzip2","cab","caf","cgm","class","cmx","cpio","cr2","cur","dat","dcm","deb","dex","djvu","dll","dmg","dng","doc","docm","docx","dot","dotm","dra","DS_Store","dsk","dts","dtshd","dvb","dwg","dxf","ecelp4800","ecelp7470","ecelp9600","egg","eol","eot","epub","exe","f4v","fbs","fh","fla","flac","flatpak","fli","flv","fpx","fst","fvt","g3","gh","gif","graffle","gz","gzip","h261","h263","h264","icns","ico","ief","img","ipa","iso","jar","jpeg","jpg","jpgv","jpm","jxr","key","ktx","lha","lib","lvp","lz","lzh","lzma","lzo","m3u","m4a","m4v","mar","mdi","mht","mid","midi","mj2","mka","mkv","mmr","mng","mobi","mov","movie","mp3","mp4","mp4a","mpeg","mpg","mpga","mxu","nef","npx","numbers","nupkg","o","odp","ods","odt","oga","ogg","ogv","otf","ott","pages","pbm","pcx","pdb","pdf","pea","pgm","pic","png","pnm","pot","potm","potx","ppa","ppam","ppm","pps","ppsm","ppsx","ppt","pptm","pptx","psd","pya","pyc","pyo","pyv","qt","rar","ras","raw","resources","rgb","rip","rlc","rmf","rmvb","rpm","rtf","rz","s3m","s7z","scpt","sgi","shar","snap","sil","sketch","slk","smv","snk","so","stl","suo","sub","swf","tar","tbz","tbz2","tga","tgz","thmx","tif","tiff","tlz","ttc","ttf","txz","udf","uvh","uvi","uvm","uvp","uvs","uvu","viv","vob","war","wav","wax","wbmp","wdp","weba","webm","webp","whl","wim","wm","wma","wmv","wmx","woff","woff2","wrm","wvx","xbm","xif","xla","xlam","xls","xlsb","xlsm","xlsx","xlt","xltm","xltx","xm","xmind","xpi","xpm","xwd","xz","z","zip","zipx"]),ee=r=>te.has(m.extname(r).slice(1).toLowerCase()),B=(r,t)=>{r instanceof Set?r.forEach(t):t(r)},N=(r,t,e)=>{let i=r[t];i instanceof Set||(r[t]=i=new Set([i])),i.add(e)},se=r=>t=>{let e=r[t];e instanceof Set?e.clear():delete r[t]},F=(r,t,e)=>{let i=r[t];i instanceof Set?i.delete(e):i===e&&delete r[t]},wt=r=>r instanceof Set?r.size===0:!r,L=new Map;function ut(r,t,e,i,s){let n=(a,o)=>{e(r),s(a,o,{watchedPath:r}),o&&r!==o&&k(m.resolve(r,o),P,m.join(r,o))};try{return Ut(r,{persistent:t.persistent},n)}catch(a){i(a);return}}var k=(r,t,e,i,s)=>{let n=L.get(r);n&&B(n[t],a=>{a(e,i,s)})},ie=(r,t,e,i)=>{let{listener:s,errHandler:n,rawEmitter:a}=i,o=L.get(t),h;if(!e.persistent)return h=ut(r,e,s,n,a),h?h.close.bind(h):void 0;if(o)N(o,P,s),N(o,W,n),N(o,v,a);else{if(h=ut(r,e,k.bind(null,t,P),n,k.bind(null,t,v)),!h)return;h.on(y.ERROR,async l=>{let c=k.bind(null,t,W);if(o&&(o.watcherUnusable=!0),Q&&l.code==="EPERM")try{await(await Jt(r,"r")).close(),c(l)}catch{}else c(l)}),o={listeners:s,errHandlers:n,rawEmitters:a,watcher:h},L.set(t,o)}return()=>{F(o,P,s),F(o,W,n),F(o,v,a),wt(o.listeners)&&(o.watcher.close(),L.delete(t),Zt.forEach(se(o)),o.watcher=void 0,Object.freeze(o))}},V=new Map,re=(r,t,e,i)=>{let{listener:s,rawEmitter:n}=i,a=V.get(t),o=a&&a.options;return o&&(o.persistent<e.persistent||o.interval>e.interval)&&(dt(t),a=void 0),a?(N(a,P,s),N(a,v,n)):(a={listeners:s,rawEmitters:n,options:e,watcher:Yt(t,e,(h,l)=>{B(a.rawEmitters,f=>{f(y.CHANGE,t,{curr:h,prev:l})});let c=h.mtimeMs;(h.size!==l.size||c>l.mtimeMs||c===0)&&B(a.listeners,f=>f(r,h))})},V.set(t,a)),()=>{F(a,P,s),F(a,v,n),wt(a.listeners)&&(V.delete(t),dt(t),a.options=a.watcher=void 0,Object.freeze(a))}},j=class{constructor(t){this.fsw=t,this._boundHandleError=e=>t._handleError(e)}_watchWithNodeFs(t,e){let i=this.fsw.options,s=m.dirname(t),n=m.basename(t);this.fsw._getWatchedDir(s).add(n);let o=m.resolve(t),h={persistent:i.persistent};e||(e=z);let l;if(i.usePolling){let c=i.interval!==i.binaryInterval;h.interval=c&&ee(n)?i.binaryInterval:i.interval,l=re(t,o,h,{listener:e,rawEmitter:this.fsw._emitRaw})}else l=ie(t,o,h,{listener:e,errHandler:this._boundHandleError,rawEmitter:this.fsw._emitRaw});return l}_handleFile(t,e,i){if(this.fsw.closed)return;let s=m.dirname(t),n=m.basename(t),a=this.fsw._getWatchedDir(s),o=e;if(a.has(n))return;let h=async(c,f)=>{if(this.fsw._throttle(Qt,t,5)){if(!f||f.mtimeMs===0)try{let u=await mt(t);if(this.fsw.closed)return;let _=u.atimeMs,w=u.mtimeMs;if((!_||_<=w||w!==o.mtimeMs)&&this.fsw._emit(y.CHANGE,t,u),(Vt||Bt||qt)&&o.ino!==u.ino){this.fsw._closeFile(c),o=u;let S=this._watchWithNodeFs(t,h);S&&this.fsw._addPathCloser(c,S)}else o=u}catch{this.fsw._remove(s,n)}else if(a.has(n)){let u=f.atimeMs,_=f.mtimeMs;(!u||u<=_||_!==o.mtimeMs)&&this.fsw._emit(y.CHANGE,t,f),o=f}}},l=this._watchWithNodeFs(t,h);if(!(i&&this.fsw.options.ignoreInitial)&&this.fsw._isntIgnored(t)){if(!this.fsw._throttle(y.ADD,t,0))return;this.fsw._emit(y.ADD,t,e)}return l}async _handleSymlink(t,e,i,s){if(this.fsw.closed)return;let n=t.fullPath,a=this.fsw._getWatchedDir(e);if(!this.fsw.options.followSymlinks){this.fsw._incrReadyCount();let o;try{o=await K(i)}catch{return this.fsw._emitReady(),!0}return this.fsw.closed?void 0:(a.has(s)?this.fsw._symlinkPaths.get(n)!==o&&(this.fsw._symlinkPaths.set(n,o),this.fsw._emit(y.CHANGE,i,t.stats)):(a.add(s),this.fsw._symlinkPaths.set(n,o),this.fsw._emit(y.ADD,i,t.stats)),this.fsw._emitReady(),!0)}if(this.fsw._symlinkPaths.has(n))return!0;this.fsw._symlinkPaths.set(n,!0)}_handleRead(t,e,i,s,n,a,o){if(t=m.join(t,""),o=this.fsw._throttle("readdir",t,1e3),!o)return;let h=this.fsw._getWatchedDir(i.path),l=new Set,c=this.fsw._readdirp(t,{fileFilter:f=>i.filterPath(f),directoryFilter:f=>i.filterDir(f)});if(c)return c.on(Kt,async f=>{if(this.fsw.closed){c=void 0;return}let u=f.path,_=m.join(t,u);if(l.add(u),!(f.stats.isSymbolicLink()&&await this._handleSymlink(f,t,_,u))){if(this.fsw.closed){c=void 0;return}(u===s||!s&&!h.has(u))&&(this.fsw._incrReadyCount(),_=m.join(n,m.relative(n,_)),this._addToNodeFs(_,e,i,a+1))}}).on(y.ERROR,this._boundHandleError),new Promise((f,u)=>{if(!c)return u();c.once(q,()=>{if(this.fsw.closed){c=void 0;return}let _=o?o.clear():!1;f(void 0),h.getChildren().filter(w=>w!==t&&!l.has(w)).forEach(w=>{this.fsw._remove(t,w)}),c=void 0,_&&this._handleRead(t,!1,i,s,n,a,o)})})}async _handleDir(t,e,i,s,n,a,o){let h=this.fsw._getWatchedDir(m.dirname(t)),l=h.has(m.basename(t));!(i&&this.fsw.options.ignoreInitial)&&!n&&!l&&this.fsw._emit(y.ADD_DIR,t,e),h.add(m.basename(t)),this.fsw._getWatchedDir(t);let c,f,u=this.fsw.options.depth;if((u==null||s<=u)&&!this.fsw._symlinkPaths.has(o)){if(!n&&(await this._handleRead(t,i,a,n,t,s,c),this.fsw.closed))return;f=this._watchWithNodeFs(t,(_,w)=>{w&&w.mtimeMs===0||this._handleRead(_,!1,a,n,t,s,c)})}return f}async _addToNodeFs(t,e,i,s,n){let a=this.fsw._emitReady;if(this.fsw._isIgnored(t)||this.fsw.closed)return a(),!1;let o=this.fsw._getWatchHelpers(t);i&&(o.filterPath=h=>i.filterPath(h),o.filterDir=h=>i.filterDir(h));try{let h=await Xt[o.statMethod](o.watchPath);if(this.fsw.closed)return;if(this.fsw._isIgnored(o.watchPath,h))return a(),!1;let l=this.fsw.options.followSymlinks,c;if(h.isDirectory()){let f=m.resolve(t),u=l?await K(t):t;if(this.fsw.closed||(c=await this._handleDir(o.watchPath,h,e,s,n,o,u),this.fsw.closed))return;f!==u&&u!==void 0&&this.fsw._symlinkPaths.set(f,u)}else if(h.isSymbolicLink()){let f=l?await K(t):t;if(this.fsw.closed)return;let u=m.dirname(o.watchPath);if(this.fsw._getWatchedDir(u).add(o.watchPath),this.fsw._emit(y.ADD,o.watchPath,h),c=await this._handleDir(u,h,e,s,t,o,f),this.fsw.closed)return;f!==void 0&&this.fsw._symlinkPaths.set(m.resolve(t),f)}else c=this._handleFile(o.watchPath,h,e);return a(),c&&this.fsw._addPathCloser(t,c),!1}catch(h){if(this.fsw._handleError(h))return a(),t}}};var X="/",ce="//",Tt=".",le="..",fe="string",de=/\\/g,gt=/\/\//,ue=/\..*\.(sw[px])$|~$|\.subl.*\.tmp/,me=/^\.[/\\]/;function H(r){return Array.isArray(r)?r:[r]}var Z=r=>typeof r=="object"&&r!==null&&!(r instanceof RegExp);function pe(r){return typeof r=="function"?r:typeof r=="string"?t=>r===t:r instanceof RegExp?t=>r.test(t):typeof r=="object"&&r!==null?t=>{if(r.path===t)return!0;if(r.recursive){let e=d.relative(r.path,t);return e?!e.startsWith("..")&&!d.isAbsolute(e):!1}return!1}:()=>!1}function _e(r){if(typeof r!="string")throw new Error("string expected");r=d.normalize(r),r=r.replace(/\\/g,"/");let t=!1;r.startsWith("//")&&(t=!0);let e=/\/\//;for(;r.match(e);)r=r.replace(e,"/");return t&&(r="/"+r),r}function yt(r,t,e){let i=_e(t);for(let s=0;s<r.length;s++){let n=r[s];if(n(i,e))return!0}return!1}function we(r,t){if(r==null)throw new TypeError("anymatch: specify first argument");let i=H(r).map(s=>pe(s));return t==null?(s,n)=>yt(i,s,n):yt(i,t)}var Pt=r=>{let t=H(r).flat();if(!t.every(e=>typeof e===fe))throw new TypeError(`Non-string provided as watch path: ${t}`);return t.map(bt)},Et=r=>{let t=r.replace(de,X),e=!1;for(t.startsWith(ce)&&(e=!0);t.match(gt);)t=t.replace(gt,X);return e&&(t=X+t),t},bt=r=>Et(d.normalize(Et(r))),Rt=(r="")=>t=>typeof t=="string"?bt(d.isAbsolute(t)?t:d.join(r,t)):t,ge=(r,t)=>d.isAbsolute(r)?r:d.join(t,r),ye=Object.freeze(new Set),tt=class{constructor(t,e){this.path=t,this._removeWatcher=e,this.items=new Set}add(t){let{items:e}=this;e&&t!==Tt&&t!==le&&e.add(t)}async remove(t){let{items:e}=this;if(!e||(e.delete(t),e.size>0))return;let i=this.path;try{await ae(i)}catch{this._removeWatcher&&this._removeWatcher(d.dirname(i),d.basename(i))}}has(t){let{items:e}=this;if(e)return e.has(t)}getChildren(){let{items:t}=this;return t?[...t.values()]:[]}dispose(){this.items.clear(),this.path="",this._removeWatcher=z,this.items=ye,Object.freeze(this)}},Pe="stat",Ee="lstat",et=class{constructor(t,e,i){this.fsw=i;let s=t;this.path=t=t.replace(me,""),this.watchPath=s,this.fullWatchPath=d.resolve(s),this.dirParts=[],this.dirParts.forEach(n=>{n.length>1&&n.pop()}),this.followSymlinks=e,this.statMethod=e?Pe:Ee}entryPath(t){return d.join(this.watchPath,d.relative(this.watchPath,t.fullPath))}filterPath(t){let{stats:e}=t;if(e&&e.isSymbolicLink())return this.filterDir(t);let i=this.entryPath(t);return this.fsw._isntIgnored(i,e)&&this.fsw._hasReadPermissions(e)}filterDir(t){return this.fsw._isntIgnored(this.entryPath(t),t.stats)}},Y=class extends he{constructor(t={}){super(),this.closed=!1,this._closers=new Map,this._ignoredPaths=new Set,this._throttled=new Map,this._streams=new Set,this._symlinkPaths=new Map,this._watched=new Map,this._pendingWrites=new Map,this._pendingUnlinks=new Map,this._readyCount=0,this._readyEmitted=!1;let e=t.awaitWriteFinish,i={stabilityThreshold:2e3,pollInterval:100},s={persistent:!0,ignoreInitial:!1,ignorePermissionErrors:!1,interval:100,binaryInterval:300,followSymlinks:!0,usePolling:!1,atomic:!0,...t,ignored:t.ignored?H(t.ignored):H([]),awaitWriteFinish:e===!0?i:typeof e=="object"?{...i,...e}:!1};_t&&(s.usePolling=!0),s.atomic===void 0&&(s.atomic=!s.usePolling);let n=process.env.CHOKIDAR_USEPOLLING;if(n!==void 0){let h=n.toLowerCase();h==="false"||h==="0"?s.usePolling=!1:h==="true"||h==="1"?s.usePolling=!0:s.usePolling=!!h}let a=process.env.CHOKIDAR_INTERVAL;a&&(s.interval=Number.parseInt(a,10));let o=0;this._emitReady=()=>{o++,o>=this._readyCount&&(this._emitReady=z,this._readyEmitted=!0,process.nextTick(()=>this.emit(p.READY)))},this._emitRaw=(...h)=>this.emit(p.RAW,...h),this._boundRemove=this._remove.bind(this),this.options=s,this._nodeFsHandler=new j(this),Object.freeze(s)}_addIgnoredPath(t){if(Z(t)){for(let e of this._ignoredPaths)if(Z(e)&&e.path===t.path&&e.recursive===t.recursive)return}this._ignoredPaths.add(t)}_removeIgnoredPath(t){if(this._ignoredPaths.delete(t),typeof t=="string")for(let e of this._ignoredPaths)Z(e)&&e.path===t&&this._ignoredPaths.delete(e)}add(t,e,i){let{cwd:s}=this.options;this.closed=!1,this._closePromise=void 0;let n=Pt(t);return s&&(n=n.map(a=>ge(a,s))),n.forEach(a=>{this._removeIgnoredPath(a)}),this._userIgnored=void 0,this._readyCount||(this._readyCount=0),this._readyCount+=n.length,Promise.all(n.map(async a=>{let o=await this._nodeFsHandler._addToNodeFs(a,!i,void 0,0,e);return o&&this._emitReady(),o})).then(a=>{this.closed||a.forEach(o=>{o&&this.add(d.dirname(o),d.basename(e||o))})}),this}unwatch(t){if(this.closed)return this;let e=Pt(t),{cwd:i}=this.options;return e.forEach(s=>{!d.isAbsolute(s)&&!this._closers.has(s)&&(i&&(s=d.join(i,s)),s=d.resolve(s)),this._closePath(s),this._addIgnoredPath(s),this._watched.has(s)&&this._addIgnoredPath({path:s,recursive:!0}),this._userIgnored=void 0}),this}close(){if(this._closePromise)return this._closePromise;this.closed=!0,this.removeAllListeners();let t=[];return this._closers.forEach(e=>e.forEach(i=>{let s=i();s instanceof Promise&&t.push(s)})),this._streams.forEach(e=>e.destroy()),this._userIgnored=void 0,this._readyCount=0,this._readyEmitted=!1,this._watched.forEach(e=>e.dispose()),this._closers.clear(),this._watched.clear(),this._streams.clear(),this._symlinkPaths.clear(),this._throttled.clear(),this._closePromise=t.length?Promise.all(t).then(()=>{}):Promise.resolve(),this._closePromise}getWatched(){let t={};return this._watched.forEach((e,i)=>{let n=(this.options.cwd?d.relative(this.options.cwd,i):i)||Tt;t[n]=e.getChildren().sort()}),t}emitWithAll(t,e){this.emit(t,...e),t!==p.ERROR&&this.emit(p.ALL,t,...e)}async _emit(t,e,i){if(this.closed)return;let s=this.options;Q&&(e=d.normalize(e)),s.cwd&&(e=d.relative(s.cwd,e));let n=[e];i!=null&&n.push(i);let a=s.awaitWriteFinish,o;if(a&&(o=this._pendingWrites.get(e)))return o.lastChange=new Date,this;if(s.atomic){if(t===p.UNLINK)return this._pendingUnlinks.set(e,[t,...n]),setTimeout(()=>{this._pendingUnlinks.forEach((h,l)=>{this.emit(...h),this.emit(p.ALL,...h),this._pendingUnlinks.delete(l)})},typeof s.atomic=="number"?s.atomic:100),this;t===p.ADD&&this._pendingUnlinks.has(e)&&(t=p.CHANGE,this._pendingUnlinks.delete(e))}if(a&&(t===p.ADD||t===p.CHANGE)&&this._readyEmitted){let h=(l,c)=>{l?(t=p.ERROR,n[0]=l,this.emitWithAll(t,n)):c&&(n.length>1?n[1]=c:n.push(c),this.emitWithAll(t,n))};return this._awaitWriteFinish(e,a.stabilityThreshold,t,h),this}if(t===p.CHANGE&&!this._throttle(p.CHANGE,e,50))return this;if(s.alwaysStat&&i===void 0&&(t===p.ADD||t===p.ADD_DIR||t===p.CHANGE)){let h=s.cwd?d.join(s.cwd,e):e,l;try{l=await oe(h)}catch{}if(!l||this.closed)return;n.push(l)}return this.emitWithAll(t,n),this}_handleError(t){let e=t&&t.code;return t&&e!=="ENOENT"&&e!=="ENOTDIR"&&(!this.options.ignorePermissionErrors||e!=="EPERM"&&e!=="EACCES")&&this.emit(p.ERROR,t),t||this.closed}_throttle(t,e,i){this._throttled.has(t)||this._throttled.set(t,new Map);let s=this._throttled.get(t);if(!s)throw new Error("invalid throttle");let n=s.get(e);if(n)return n.count++,!1;let a,o=()=>{let l=s.get(e),c=l?l.count:0;return s.delete(e),clearTimeout(a),l&&clearTimeout(l.timeoutObject),c};a=setTimeout(o,i);let h={timeoutObject:a,clear:o,count:0};return s.set(e,h),h}_incrReadyCount(){return this._readyCount++}_awaitWriteFinish(t,e,i,s){let n=this.options.awaitWriteFinish;if(typeof n!="object")return;let a=n.pollInterval,o,h=t;this.options.cwd&&!d.isAbsolute(t)&&(h=d.join(this.options.cwd,t));let l=new Date,c=this._pendingWrites;function f(u){ne(h,(_,w)=>{if(_||!c.has(t)){_&&_.code!=="ENOENT"&&s(_);return}let S=Number(new Date);u&&w.size!==u.size&&(c.get(t).lastChange=S);let St=c.get(t);S-St.lastChange>=e?(c.delete(t),s(void 0,w)):o=setTimeout(f,a,w)})}c.has(t)||(c.set(t,{lastChange:l,cancelWait:()=>(c.delete(t),clearTimeout(o),i)}),o=setTimeout(f,a))}_isIgnored(t,e){if(this.options.atomic&&ue.test(t))return!0;if(!this._userIgnored){let{cwd:i}=this.options,n=(this.options.ignored||[]).map(Rt(i)),o=[...[...this._ignoredPaths].map(Rt(i)),...n];this._userIgnored=we(o,void 0)}return this._userIgnored(t,e)}_isntIgnored(t,e){return!this._isIgnored(t,e)}_getWatchHelpers(t){return new et(t,this.options.followSymlinks,this)}_getWatchedDir(t){let e=d.resolve(t);return this._watched.has(e)||this._watched.set(e,new tt(e,this._boundRemove)),this._watched.get(e)}_hasReadPermissions(t){return this.options.ignorePermissionErrors?!0:!!(Number(t.mode)&256)}_remove(t,e,i){let s=d.join(t,e),n=d.resolve(s);if(i=i??(this._watched.has(s)||this._watched.has(n)),!this._throttle("remove",s,100))return;!i&&this._watched.size===1&&this.add(t,e,!0),this._getWatchedDir(s).getChildren().forEach(u=>this._remove(s,u));let h=this._getWatchedDir(t),l=h.has(e);h.remove(e),this._symlinkPaths.has(n)&&this._symlinkPaths.delete(n);let c=s;if(this.options.cwd&&(c=d.relative(this.options.cwd,s)),this.options.awaitWriteFinish&&this._pendingWrites.has(c)&&this._pendingWrites.get(c).cancelWait()===p.ADD)return;this._watched.delete(s),this._watched.delete(n);let f=i?p.UNLINK_DIR:p.UNLINK;l&&!this._isIgnored(s)&&this._emit(f,s),this._closePath(s)}_closePath(t){this._closeFile(t);let e=d.dirname(t);this._getWatchedDir(e).remove(d.basename(t))}_closeFile(t){let e=this._closers.get(t);e&&(e.forEach(i=>i()),this._closers.delete(t))}_addPathCloser(t,e){if(!e)return;let i=this._closers.get(t);i||(i=[],this._closers.set(t,i)),i.push(e)}_readdirp(t,e){if(this.closed)return;let i={type:p.ALL,alwaysStat:!0,lstat:!0,...e,depth:0},s=ft(t,i);return this._streams.add(s),s.once(pt,()=>{s=void 0}),s.once(q,()=>{s&&(this._streams.delete(s),s=void 0)}),s}};function Re(r,t={}){let e=new Y(t);return e.add(r),e}var Dt={watch:Re,FSWatcher:Y};import U from"lodash";var st=class{userConfigPath=A.resolve(C,"config",O,"config.json");defConfigPath=A.resolve(E,"resources","config/config.json");schemaPath=A.resolve(E,"schema","config.schema.json");schemaRelativePath=A.relative(A.dirname(this.userConfigPath),this.schemaPath);config=D.getJSON(this.defConfigPath);#t;async init(){return Te.existsSync(this.userConfigPath)||(D.createDir(this.userConfigPath,void 0,!0),await D.writeJSON(this.userConfigPath,this.config)),this.config.$schema=this.schemaRelativePath,await this.load(),this.watch(),this}async load(){let t=D.getJSON(this.userConfigPath,void 0,!1);U.isEqual(t,this.config)||(this.config=U.merge({},t,this.config),await this.save())}get test(){return this.config.test}async save(){return D.writeJSON(this.userConfigPath,this.config)}async set(t,e){return U.set(this.config,t,e),this.save()}get(t,e){return U.get(this.config,t,e)}watch(){this.#t||(this.#t=Dt.watch(this.userConfigPath,{persistent:!0,ignoreInitial:!0}),this.#t.on("change",async()=>{try{await this.load(),logger.debug(`[${O}] \u914D\u7F6E\u5DF2\u66F4\u65B0`)}catch(t){logger.error(`[${O}] \u914D\u7F6E\u91CD\u8F7D\u5931\u8D25 `,t)}}))}unwatch(){this.#t?.close(),this.#t=void 0}},it=await new st().init();var vt=class extends plugin{constructor(){super({name:"\u6D4B\u8BD5",dsc:"\u6D4B\u8BD5\u529F\u80FD",priority:500,event:"message",rule:[{reg:/#测试/i,fnc:"test"}]})}async test(t=this.e){return t.reply(`\u4F60\u597D\uFF0C\u6211\u7684\u540D\u5B57\u662F${it.test.name}, \u6211\u4ECA\u5E74\u521A\u6EE1${it.test.age}\u5C81`),!0}};export{vt as test};
/*! Bundled license information:

chokidar/esm/index.js:
  (*! chokidar - MIT License (c) 2012 Paul Miller (paulmillr.com) *)
*/
